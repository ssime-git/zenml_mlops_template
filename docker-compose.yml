version: '3.8'

services:
  mlflow:
    image: ghcr.io/mlflow/mlflow:latest
    ports:
      - "5001:5000"
    volumes:
      - ./mlflow-artifacts:/mlflow/artifacts
    command: mlflow server --host 0.0.0.0 --port 5000 --default-artifact-root /mlflow/artifacts
    restart: unless-stopped

  data-preprocess:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.preprocess
    volumes:
      - ./data-file:/app/data-file

  train-model:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.train
    volumes:
      - ./data-file:/app/data-file
      - ./src:/app/src
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - ZENML_SERVER_URL=http://zenml:8080
      - ZENML_DISABLE_CLIENT_SERVER_MISMATCH_CHECK=true
      - ZENML_ANALYTICS_OPT_IN=false
      - ZENML_STORE_TYPE=rest
      - ZENML_STORE_URL=http://zenml:8080
      - ZENML_API_KEY=${ZENML_API_KEY}
      - ZENML_AUTO_ACCEPT_PROMPTS=true
    depends_on:
      mlflow:
        condition: service_started
      zenml:
        condition: service_started
    restart: on-failure

  inference-api:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.inference
    volumes:
      - ./data-file:/app/data-file
      - .:/app/workspace
    ports:
      - "8000:8000"
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
    depends_on:
      - mlflow
    restart: on-failure

  # Retraining Monitor Service
  retrain-monitor:
    build:
      context: .
      dockerfile: dockerfiles/Dockerfile.monitor
    volumes:
      - ./data-file:/app/data-file
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SIGNAL_FILE_PATH=/app/data-file/retrain_requested
      - CHECK_INTERVAL=5
    restart: always
    depends_on:
      - inference-api
      - train-model

  zenml:
    image: zenmldocker/zenml-server
    ports:
      - "8080:8080"
    environment:
      - ZENML_DEFAULT_USER_NAME=admin
      - ZENML_DEFAULT_USER_PASSWORD=P@ssword123$
      - ZENML_STORE_TYPE=sql
      - ZENML_STORE_URL=mysql://root:password@mysql/zenml
      - ZENML_DEFAULT_PROJECT_NAME=default
      - ZENML_ANALYTICS_OPT_IN=false
      - ZENML_LOGGING_VERBOSITY=INFO
      - ZENML_SERVER_DEPLOYMENT_TYPE=docker
      - ZENML_DISABLE_CLIENT_SERVER_MISMATCH_CHECK=true
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - zenml_data:/var/lib/zenml

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: zenml
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-ppassword"]
      interval: 5s
      timeout: 5s
      retries: 20

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    depends_on:
      - inference-api

  grafana:
    image: grafana/grafana-oss:latest
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  mlflow_data:
  prometheus_data:
  grafana_data:
  mysql_data:
  zenml_data: